name: Sync Task Master to GitHub Issues

on:
  push:
    paths:
      - '.taskmaster/tasks/tasks.json'
  workflow_dispatch:

jobs:
  sync-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Sync Tasks to GitHub Issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tasksFile = fs.readFileSync('.taskmaster/tasks/tasks.json', 'utf8');
            const tasksData = JSON.parse(tasksFile);
            const tasks = tasksData.master?.tasks || [];
            
            const statusLabels = {
              'pending': 'status:pending',
              'in-progress': 'status:in-progress',
              'done': 'status:done',
              'blocked': 'status:blocked'
            };
            
            const ensureLabel = async (name, color) => {
              try {
                await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name });
              } catch {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, name, color });
              }
            };
            
            await ensureLabel('status:pending', 'cccccc');
            await ensureLabel('status:in-progress', '0052cc');
            await ensureLabel('status:done', '0e8a16');
            await ensureLabel('status:blocked', 'd73a49');
            await ensureLabel('priority:high', 'b60205');
            await ensureLabel('priority:medium', 'fbca04');
            await ensureLabel('taskmaster', '1d76db');
            
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: 'all', per_page: 100
            });
            
            for (const task of tasks) {
              const marker = `<!-- tm:${task.id} -->`;
              const existing = existingIssues.find(i => i.body?.includes(marker));
              const labels = ['taskmaster', statusLabels[task.status] || 'status:pending'];
              if (task.priority) labels.push(`priority:${task.priority}`);
              
              const body = `${marker}\n\n${task.description}\n\n**Details:** ${task.details || 'None'}\n\n**Test:** ${task.testStrategy || 'None'}\n\n*Managed by Task Master*`;
              
              if (existing) {
                await github.rest.issues.update({
                  owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number,
                  title: `[TM-${task.id}] ${task.title}`, body, labels,
                  state: task.status === 'done' ? 'closed' : 'open'
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner, repo: context.repo.repo,
                  title: `[TM-${task.id}] ${task.title}`, body, labels
                });
              }
            }
